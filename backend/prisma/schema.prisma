generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model WorkingHours {
  id      Int    @id @default(autoincrement())
  day     String
  opening String
  closing String
}

model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  password         String
  first_name       String
  telephone_number String
  city             String
  country          String
  postal_address   String
  roleId           Int?
  role             Role?     @relation(fields: [roleId], references: [id])
  publishes        Publish[]
  orders           Order[]
  passwordResetTokens PasswordResetToken[]
  
  // RGPD Consent tracking
  gdprConsent      Boolean   @default(false)
  gdprConsentDate  DateTime?
  marketingConsent Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now()) @updatedAt

  @@index([roleId])
  @@index([email])
}

model Role {
  id      Int    @id @default(autoincrement())
  libelle String
  users   User[]
}

model Publish {
  id          Int    @id @default(autoincrement())
  note        String
  description String
  status      String
  userId      Int
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id               Int      @id @default(autoincrement())
  order_number     String
  order_date       DateTime
  prestation_date  DateTime
  delivery_hour    String
  menu_price       Float
  person_number    Int
  delivery_price   Float
  status           String
  material_lending Boolean
  get_back_material Boolean
  userId           Int
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  menus            Menu[]   @relation("OrderMenus")

  @@index([userId])
  @@index([status])
  @@index([order_date])
}

model Menu {
  id               Int      @id @default(autoincrement())
  title            String
  person_min       Int
  price_per_person Float
  dietId           Int?
  diet             Diet?    @relation(fields: [dietId], references: [id])
  themeId          Int?
  theme            Theme?   @relation(fields: [themeId], references: [id])
  description      String
  remaining_qty    Int
  orders           Order[]  @relation("OrderMenus")
  dishes           Dish[]

  @@index([dietId])
  @@index([themeId])
  @@index([title])
}

model Diet {
  id      Int    @id @default(autoincrement())
  libelle String
  menus   Menu[]
}

model Theme {
  id      Int    @id @default(autoincrement())
  libelle String
  menus   Menu[]
}

model Dish {
  id         Int        @id @default(autoincrement())
  title_dish String
  photo      String     @default("")
  description String    @default("")
  course_type String    @default("plat") // "entree", "plat", "dessert"
  menus      Menu[]     @relation("MenuDishes")
  allergens  Allergen[] @relation("DishAllergens")
  ingredients DishIngredient[]

  @@index([course_type])
}

model Ingredient {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  unit             String   @default("kg")
  current_stock    Float    @default(0)
  min_stock_level  Float    @default(0)
  cost_per_unit    Float    @default(0)
  last_restocked_at DateTime?
  dishes           DishIngredient[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now()) @updatedAt

  @@index([name])
}

model DishIngredient {
  dish_id      Int
  ingredient_id Int
  quantity     Float @default(0) // Quantity needed per serving
  dish         Dish   @relation(fields: [dish_id], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)

  @@id([dish_id, ingredient_id])
  @@index([dish_id])
  @@index([ingredient_id])
}

model Allergen {
  id      Int    @id @default(autoincrement())
  libelle String
  dishes  Dish[] @relation("DishAllergens")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}
