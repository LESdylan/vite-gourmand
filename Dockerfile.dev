# ============================================
# VITE GOURMAND â€” Development Container
# ============================================
# This Dockerfile provides a complete development environment
# with Node.js, npm, and all necessary tools.
#
# Use this when you don't have Node.js installed on your host machine
# (e.g., school computers with Docker-only access).
#
# Usage:
#   make docker-dev      # Full containerized bootstrap
#   make docker-shell    # Interactive shell in the container
#   make deploy          # Deploy to Fly.io (flyctl included!)
# ============================================

FROM node:22-alpine

# Install essential tools
RUN apk add --no-cache \
    bash \
    curl \
    git \
    jq \
    make \
    psmisc \
    procps \
    # For native modules compilation
    python3 \
    g++ \
    # For Prisma
    openssl \
    libc6-compat

# Install Fly.io CLI (flyctl) - no sudo required!
# Installed to /opt/fly (not /root/.fly) to avoid conflicts with Docker volume
# that persists auth tokens at /root/.fly
RUN FLYCTL_INSTALL="/opt/fly" sh -c 'curl -L https://fly.io/install.sh | sh'
ENV FLYCTL_INSTALL="/opt/fly"
ENV PATH="/opt/fly/bin:$PATH"

# Set working directory
WORKDIR /app

# Create non-root user for better security (optional, use --user flag)
# RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Set npm to be less verbose and suppress funding/update messages
ENV NPM_CONFIG_LOGLEVEL=warn
ENV NPM_CONFIG_CACHE=/app/.npm-cache
ENV NPM_CONFIG_FUND=false
ENV NPM_CONFIG_UPDATE_NOTIFIER=false

# Install global tools (suppress deprecation warnings)
RUN npm install -g \
    typescript \
    @nestjs/cli \
    prisma \
    2>/dev/null

# Health check - verify node is working
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node -v || exit 1

# Default command - keep container running for development
CMD ["tail", "-f", "/dev/null"]
