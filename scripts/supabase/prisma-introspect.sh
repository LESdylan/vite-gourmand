#!/usr/bin/env bash
# ============================================
# Introspect Supabase â†’ generate Prisma schema
# This maps the SQL tables to Prisma models
# without Prisma owning the schema.
# Works with Prisma 7+ (uses prisma.config.ts)
# Schema is stored in src/Model/prisma/ (MVC)
# ============================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
BACKEND_DIR="$PROJECT_ROOT/Back"
PRISMA_DIR="$BACKEND_DIR/src/Model/prisma"
ENV_FILE="$BACKEND_DIR/.env"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log()   { echo -e "${BLUE}[INFO]${NC} $1"; }
ok()    { echo -e "${GREEN}[OK]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# â”€â”€ Load environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f "$ENV_FILE" ]; then
    # Load only DATABASE_URL and DIRECT_URL (avoid space issues)
    export DATABASE_URL=$(grep -E '^DATABASE_URL=' "$ENV_FILE" | cut -d '=' -f2- | tr -d '"')
    export DIRECT_URL=$(grep -E '^DIRECT_URL=' "$ENV_FILE" | cut -d '=' -f2- | tr -d '"')
    log "Loaded database URLs from $ENV_FILE"
else
    error ".env file not found at $ENV_FILE"
fi

# â”€â”€ Ensure prisma directory exists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mkdir -p "$PRISMA_DIR"

# â”€â”€ Create Prisma schema with env references â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cat > "$PRISMA_DIR/schema.prisma" << 'PRISMA_SCHEMA'
// This schema is AUTO-GENERATED by introspection.
// Do NOT edit manually â€” run: make prisma-introspect
//
// The source of truth is: Back/src/Model/sql/schemas/
// Prisma only maps the existing tables for ORM access.
// Connection URLs are configured in prisma.config.ts (Prisma 7+)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}
PRISMA_SCHEMA

log "Prisma 7 compatible schema created at $PRISMA_DIR/schema.prisma"

# â”€â”€ Ensure deps installed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ ! -d "$BACKEND_DIR/node_modules/.prisma" ]; then
    log "Installing Prisma dependencies..."
    cd "$BACKEND_DIR" && npm install prisma @prisma/client --save-dev 2>&1
fi

# â”€â”€ Run introspection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log "Introspecting Supabase database..."
cd "$BACKEND_DIR"

if ! npx prisma db pull --schema=src/Model/prisma/schema.prisma 2>&1; then
    error "Prisma introspection failed. Is the database deployed?"
fi

ok "Prisma schema generated from Supabase!"

# â”€â”€ Generate client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log "Generating Prisma Client..."
npx prisma generate --schema=src/Model/prisma/schema.prisma 2>&1

ok "Prisma Client generated!"
echo ""
echo "  ðŸ“„ Schema: $PRISMA_DIR/schema.prisma"
echo "  ðŸ“¦ Client: $BACKEND_DIR/node_modules/.prisma/client"
echo ""
echo "  Usage in NestJS:"
echo "    import { PrismaClient } from '@prisma/client';"
echo "    const prisma = new PrismaClient();"
echo ""
