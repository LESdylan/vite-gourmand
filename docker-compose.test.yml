version: "3.8"

# Docker Compose for running Postman collections via Newman
# Usage: docker compose -f docker-compose.test.yml run postman-tests

services:
  # Main API for testing
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=test
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=test-secret-key
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # Newman - Postman CLI runner
  postman-tests:
    image: postman/newman:6-alpine
    depends_on:
      api:
        condition: service_healthy
    volumes:
      # Mount local collections
      - ./backend/postman:/etc/newman
      # Mount reports output
      - ./reports:/etc/newman/reports
    environment:
      # Postman API Key for cloud sync (set in .env)
      - POSTMAN_API_KEY=${POSTMAN_API_KEY}
    networks:
      - test-network
    # Run all collections
    command: >
      run /etc/newman/auth.json
      --environment /etc/newman/env.docker.json
      --reporters cli,htmlextra,junit
      --reporter-htmlextra-export /etc/newman/reports/auth-report.html
      --reporter-junit-export /etc/newman/reports/auth-report.xml
      --delay-request 100

  # Run from Postman Cloud (alternative)
  postman-cloud-tests:
    image: postman/newman:6-alpine
    depends_on:
      api:
        condition: service_healthy
    environment:
      - POSTMAN_API_KEY=${POSTMAN_API_KEY}
    volumes:
      - ./reports:/etc/newman/reports
    networks:
      - test-network
    # Run using Postman Cloud collection ID
    command: >
      run https://api.getpostman.com/collections/${POSTMAN_COLLECTION_ID}?apikey=${POSTMAN_API_KEY}
      --environment https://api.getpostman.com/environments/${POSTMAN_ENV_ID}?apikey=${POSTMAN_API_KEY}
      --reporters cli,htmlextra,junit
      --reporter-htmlextra-export /etc/newman/reports/cloud-report.html

networks:
  test-network:
    driver: bridge
